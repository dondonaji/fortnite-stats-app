-- ==========================================
-- 游닂 DOCUMENTACI칍N DE BASE DE DATOS (FORTNITE STATS PRO)
-- ==========================================

-- 1. TABLA: SNAPSHOTS (Historial de Jugadores)
-- ------------------------------------------
-- Esta tabla guarda "fotos" del rendimiento de un jugador en un momento dado.
-- Nos permite construir gr치ficas de progreso (ej. c칩mo mejor칩 su K/D la 칰ltima semana).
create table if not exists snapshots (
  id bigint generated by default as identity primary key, -- Identificador 칰nico
  player text not null,        -- Nombre del jugador (ej. "Ninja")
  recorded_at timestamp with time zone default timezone('utc'::text, now()) not null, -- Cu치ndo se guard칩
  kd numeric,                  -- Ratio de Bajas/Muertes
  win_rate numeric,            -- Porcentaje de Victorias
  wins integer,                -- Total de Victorias
  matches integer,             -- Total de Partidas jugadas
  level integer                -- Nivel del Pase de Batalla actual
);

-- 2. TABLA: SITE_STATS (Estad칤sticas del Sitio)
-- ------------------------------------------
-- Un contador simple para saber cu치nta gente entra a la web.
-- Solo tiene una fila (ID=1) que se actualiza constantemente.
create table if not exists site_stats (
  id bigint primary key generated always as identity,
  visits bigint default 0      -- Contador de visitas totales
);

-- Inicializar el contador en 0 si no existe
-- Inicializar el contador en 0 si no existe
insert into site_stats (id, visits)
overriding system value
values (1, 0)
on conflict (id) do nothing;

-- 3. TABLA: SEARCH_LOGS (Registro de B칰squedas) [NUEVO]
-- ------------------------------------------
-- Guarda qu칠 jugadores busca la gente. 칔til para ver tendencias ("Top Buscados").
create table if not exists search_logs (
  id bigint generated by default as identity primary key,
  query text not null,         -- Qu칠 escribieron (ej. "Tfue")
  searched_at timestamp with time zone default timezone('utc'::text, now()) -- Cu치ndo
);

-- ==========================================
-- 游댏 SEGURIDAD (RLS - Row Level Security)
-- ==========================================

-- Habilitar seguridad en las tablas
alter table site_stats enable row level security;
alter table snapshots enable row level security;
alter table search_logs enable row level security;

-- POL칈TICAS DE ACCESO (Permitir lectura/escritura p칰blica por ahora)
-- Nota: En producci칩n idealmente restringir칤amos la escritura, pero para estas stats p칰blicas est치 bien.

-- Site Stats: Todos pueden ver y sumar visitas
create policy "Public Access Stats" on site_stats for all using (true);

-- Snapshots: Todos pueden leer el historial y guardar nuevos datos si la API lo pide
create policy "Public Access Snapshots" on snapshots for all using (true);

-- Search Logs: Permitir insertar b칰squedas (idealmente solo insert, no lectura p칰blica si es privado)
create policy "Public Insert Logs" on search_logs for insert with check (true);

